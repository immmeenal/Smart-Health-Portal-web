<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Doctor Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[linear-gradient(to_right,_#bfdbfe_0%,_#bfdbfe_20%,_white_100%)] p-6">

  <div class="max-w-6xl mx-auto space-y-6">

     <!-- Profile Header -->
    <div class="flex items-center gap-4 cursor-pointer" id="profileLink">
      <div class="w-16 h-16 rounded-full bg-green-600 flex items-center justify-center text-white text-xl font-bold">
        <span id="profileInitial">P</span>
      </div>
      <div>
        <p id="profileName" class="font-semibold text-lg">Loading...</p>
        <p class="text-sm text-gray-500">View Profile</p>
      </div>
     
    </div>

    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Dashboard</h1>
      <button id="logoutBtn" class="text-red-600 underline text-sm">Logout</button>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Patients list -->
      <section class="md:col-span-1 bg-white rounded shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Patients</h2>
          <input id="search" placeholder="Search name"
                 class="border rounded px-2 py-1 text-sm w-40" />
        </div>
        <ul id="patientsList" class="divide-y"></ul>
      </section>

      <!-- Patient details -->
      <section class="md:col-span-2 bg-white rounded shadow p-4">
        <div id="emptyState" class="text-gray-500">Select a patient to view details.</div>

        <div id="patientPanel" class="hidden space-y-6">
          <!-- Info -->
          <div>
            <h3 class="text-lg font-semibold mb-2">Patient Info</h3>
            <div id="patientInfo" class="text-sm text-gray-700"></div>
          </div>

          <!-- Medical Records -->
          <div>
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold mb-2">Medical Records</h3>
              <form id="uploadForm" class="flex items-center gap-2">
                <input type="file" id="fileInput" class="text-sm" accept=".pdf,.jpg,.jpeg,.png" required />
                <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">
                  Upload
                </button>
              </form>
            </div>
            <p id="uploadMsg" class="text-sm mt-1 hidden"></p>
            <ul id="recordsList" class="list-disc list-inside text-sm text-blue-700"></ul>
          </div>

          <!-- Appointments -->
          <div>
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold mb-2">Appointments</h3>
              <span id="apptMsg" class="text-sm hidden"></span>
            </div>
            <table class="w-full border text-sm" id="apptsTable">
              <thead class="bg-gray-100">
                <tr>
                  <th class="border px-2 py-1 text-left">Date</th>
                  <th class="border px-2 py-1 text-left">Status</th>
                  <th class="border px-2 py-1 text-left">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        
      </section>

     <!-- Search Appointments by Date -->
<div class="mt-6 bg-white p-4 rounded-lg shadow-md border border-gray-200">
  <h3 class="text-lg font-semibold mb-3 text-gray-800">Search Appointments</h3>

  <!-- Date input + button -->
  <div class="flex items-center gap-3 mb-4">
    <input type="date" id="searchDateInput"
           class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none w-48"/>
    <button onclick="searchAppointmentsByDate()"
            class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 shadow-sm">
      Search
    </button>
  </div>
  

</div>

 <!--Scheduled Appointments -->
      <section class="md:col-span-2 bg-white rounded shadow p-4">
        <div id="patientAppointmentsByDate" class="text-gray-500">Scheduled Appointments</div>

        <div class="space-y-6">
          
          <div>
            <p class="text-sm mt-1 hidden"></p>
             <!-- Results table -->
              <div id="searchResults">
    <table class="min-w-full border border-gray-300 rounded-lg shadow-sm bg-white">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 border-b">Patient</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 border-b">Time</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 border-b">Status</th>
        </tr>
      </thead>
      <tbody id="searchAppointmentsBody" class="divide-y divide-gray-200 text-sm text-gray-800">
        <!-- JS will inject rows here -->
      </tbody>
    </table>
  </div>
            </div>
    </div>

    
  </div>

  <script>
    const API   = "http://localhost:3000/api";
    const token = localStorage.getItem("token");
    const role  = (localStorage.getItem("role") || "").toLowerCase();

    if (!token || role !== "provider") {
      window.location.replace("patient-dashboard.html");
    }

    const CLINIC_TZ = "Asia/Kolkata";
const fmtClinic = (dt) => {
  const d = new Date(dt);
  // subtract 5h30m
  d.setMinutes(d.getMinutes() - 330);
  return new Intl.DateTimeFormat("en-IN", {
    timeZone: CLINIC_TZ,
    year: "numeric",
    month: "numeric",
    day: "numeric",
    hour: "numeric",
    minute: "2-digit",
    hour12: true
  }).format(d);
};


    let patients = [];
    let filtered = [];
    let selectedPatient = null;

    function setMsg(id, text="", type="info"){
      const el = document.getElementById(id);
      if (!text){ el.textContent=""; el.className="text-sm hidden"; return; }
      el.textContent = text;
      el.className = "text-sm " + (type==="error" ? "text-red-600" : "text-green-700");
      el.classList.remove("hidden");
      if (id !== "uploadMsg") setTimeout(()=> setMsg(id,""), 1500);
    }

    async function loadDoctorProfile() {
  try {
    const res = await fetch(`${API}/doctor/me`, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (res.status === 401) { localStorage.clear(); return location.replace("login.html"); }
    const data = await res.json();
    if (!res.ok) return;

    document.getElementById("profileName").textContent = data.full_name || "Unknown";
    document.getElementById("profileInitial").textContent = data.full_name ? data.full_name.charAt(0).toUpperCase() : "D";
  } catch {
    document.getElementById("profileName").textContent = "Error";
  }
}

    /* ---------- Patients ---------- */
    async function loadPatients(){
      const ul = document.getElementById("patientsList");
      try{
        const res = await fetch(`${API}/doctor/patients`, {
          headers:{ "Authorization":"Bearer "+token }
        });
        if (!res.ok){ ul.innerHTML = `<li class="p-2 text-red-600 text-sm">Failed to load patients</li>`; return; }
        const data = await res.json();
        const map = new Map();
        for (const row of data) if (!map.has(row.patient_id)) map.set(row.patient_id, row);
        patients = Array.from(map.values());
        filtered = patients;
        renderPatients();
      } catch {
        ul.innerHTML = `<li class="p-2 text-red-600 text-sm">Error loading patients</li>`;
      }
    }

    function renderPatients(){
      const ul = document.getElementById("patientsList");
      ul.innerHTML = "";
      if (!filtered.length){
        ul.innerHTML = `<li class="p-2 text-gray-500 text-sm">No patients</li>`;
        return;
      }
      filtered.forEach(p=>{
        const li = document.createElement("li");
        li.className = "p-2 hover:bg-gray-50 cursor-pointer";
        li.innerHTML = `
          <div class="font-medium">${p.full_name || ("Patient #"+p.patient_id)}</div>
          <div class="text-xs text-gray-500">${p.gender ? `Gender: ${p.gender}` : ""}</div>
        `;
        li.onclick = ()=> selectPatient(p);
        ul.appendChild(li);
      });
    }

    function selectPatient(p){
      selectedPatient = p;
      document.getElementById("emptyState").classList.add("hidden");
      document.getElementById("patientPanel").classList.remove("hidden");

      document.getElementById("patientInfo").innerHTML = `
        <div><span class="text-gray-500">Name:</span> ${p.full_name || "-"}</div>
        <div><span class="text-gray-500">Gender:</span> ${p.gender || "-"}</div>
      `;

      loadRecords(p.patient_id);
      loadAppointments(p.patient_id);
      setMsg("uploadMsg","");
    }

    /* ---------- Records (uses your working list endpoint) ---------- */
    async function loadRecords(patientId){
      const ul = document.getElementById("recordsList");
      ul.innerHTML = `<li class="text-gray-500">Loadingâ€¦</li>`;
      try{
        // Your working endpoint:
        const res = await fetch(`${API}/doctor/patient/${patientId}/records`, {
          headers:{ "Authorization":"Bearer "+token }
        });
        if (!res.ok){ ul.innerHTML = `<li class="text-red-600">Failed to load records</li>`; return; }
        const data = await res.json();
        if (!data.length){ ul.innerHTML = `<li class="text-gray-500">No records</li>`; return; }
        ul.innerHTML = "";
        data.forEach(r=>{
          const name = r.file_name || r.file_path?.split("/").pop() || "file";
          const li = document.createElement("li");
          li.className = "flex items-center gap-3";
          li.innerHTML = `
            <button class="text-blue-700 underline text-left" onclick="viewRecord(${r.record_id})">${name}</button>
            <button class="text-red-600 text-xs underline" onclick="deleteFile(${r.record_id})">Delete</button>
          `;
          ul.appendChild(li);
        });
      } catch { ul.innerHTML = `<li class="text-red-600">Error loading records</li>`; }
    }

    // NEW: fetch signed URL then open
    window.viewRecord = async function(recordId){
      try{
        const res = await fetch(`${API}/records/signed/${recordId}`, {
          headers:{ "Authorization":"Bearer "+token }
        });
        const data = await res.json();
        if (!res.ok || !data.file_url) {
          setMsg("uploadMsg", data.error || "Failed to get secure link", "error");
          return;
        }
        window.open(data.file_url, "_blank");
      } catch {
        setMsg("uploadMsg", "Server error while generating link", "error");
      }
    }

    document.getElementById("uploadForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!selectedPatient) return setMsg("uploadMsg","Select a patient first","error");
      const f = document.getElementById("fileInput").files[0];
      if (!f) return setMsg("uploadMsg","Choose a file","error");
      try{
        const fd = new FormData();
        fd.append("file", f);
        fd.append("patientId", selectedPatient.patient_id); // provider uploads on behalf of patient
        const res = await fetch(`${API}/records/upload`, {
          method:"POST", headers:{ "Authorization":"Bearer "+token }, body: fd
        });
        const data = await res.json();
        if (!res.ok) return setMsg("uploadMsg", data.error || "Upload failed","error");
        setMsg("uploadMsg","âœ… Uploaded");
        document.getElementById("fileInput").value="";
        loadRecords(selectedPatient.patient_id);
      } catch { setMsg("uploadMsg","Server error","error"); }
    });

    window.deleteFile = async function(recordId){
      if (!confirm("Delete this file?")) return;
      try{
        const res = await fetch(`${API}/records/${recordId}`, {
          method:"DELETE", headers:{ "Authorization":"Bearer "+token }
        });
        const data = await res.json();
        if (!res.ok) return setMsg("uploadMsg", data.error || "Delete failed","error");
        setMsg("uploadMsg","Deleted");
        if (selectedPatient) loadRecords(selectedPatient.patient_id);
      } catch { setMsg("uploadMsg","Server error","error"); }
    }

    async function searchAppointmentsByDate() {
      const date = document.getElementById("searchDateInput").value;
      const out = document.getElementById("searchResults");

      if (!date) {
        out.innerHTML = `<p class="text-red-600">Please select a date</p>`;
        return;
      }

      out.innerHTML = `<p class="text-gray-500">Loadingâ€¦</p>`;

      try {
        // ðŸ”¹ backend: /doctor/appointments?date=YYYY-MM-DD
        // NEW âœ…
        const res = await fetch(`${API}/appointments/doctor/appointments?date=${date}`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();

        if (!res.ok) {
          out.innerHTML = `<p class="text-red-600">${data.error || "Failed to fetch"}</p>`;
          return;
        }

        if (!data.length) {
          out.innerHTML = `<p class="text-gray-500">No appointments on this date</p>`;
          return;
        }

        // render as table
        out.innerHTML = `
          <table class="w-full border text-sm mt-2">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-1 text-left">Patient</th>
                <th class="border px-2 py-1 text-left">Time</th>
                <th class="border px-2 py-1 text-left">Status</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(a => `
                <tr>
                  <td class="border px-2 py-1">${a.patient_name || "Patient #" + a.patient_id}</td>
                  <td class="border px-2 py-1">${fmtClinic(a.appointment_date)}</td>
                  <td class="border px-2 py-1">${a.status}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      } catch (e) {
        console.error("Search error", e);
        out.innerHTML = `<p class="text-red-600">Server error</p>`;
      }
}

    /* ---------- Appointments (only this doctorâ€™s with selected patient) ---------- */
    async function loadAppointments(patientId){
      const tbody = document.querySelector("#apptsTable tbody");
      tbody.innerHTML = `<tr><td colspan="3" class="p-2 text-gray-500">Loadingâ€¦</td></tr>`;
      try{
        const res = await fetch(`${API}/doctor/patient/${patientId}/appointments`, {
          headers:{ "Authorization":"Bearer "+token }
        });
        if (!res.ok){ tbody.innerHTML = `<tr><td colspan="3" class="p-2 text-red-600">Failed to load</td></tr>`; return; }
        const data = await res.json();
        if (!data.length){ tbody.innerHTML = `<tr><td colspan="3" class="p-2 text-gray-500">No appointments</td></tr>`; return; }

        tbody.innerHTML = "";
        data.forEach(a=>{
          const isCancelled = (a.status || "").toLowerCase() === "cancelled";
          const selectId = `st_${a.appointment_id}`;
          const tr = document.createElement("tr");
          tr.className = isCancelled ? "opacity-60" : "";
          tr.innerHTML = `
            <td class="border px-2 py-1 ${isCancelled?'line-through':''}">${fmtClinic(a.appointment_date)}</td>
            <td class="border px-2 py-1">
              <select id="${selectId}" class="border rounded px-2 py-1" ${isCancelled?'disabled':''}>
                ${["Scheduled","Completed","Cancelled"].map(s=>`<option value="${s}" ${s===a.status?"selected":""}>${s}</option>`).join("")}
              </select>
            </td>
            <td class="border px-2 py-1">
              <button class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700"
                ${isCancelled?'disabled':''}
                onclick="saveStatus(${a.appointment_id})">Save</button>
              <button class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 ml-2"
                ${isCancelled?'disabled':''}
                onclick="cancelAppt(${a.appointment_id})">Cancel</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch {
        tbody.innerHTML = `<tr><td colspan="3" class="p-2 text-red-600">Error</td></tr>`;
      }
    }

    window.saveStatus = async function(appointmentId){
      try{
        const sel = document.getElementById(`st_${appointmentId}`);
        const newStatus = sel.value;
        const res = await fetch(`${API}/appointments/${appointmentId}`, {
          method:"PUT",
          headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
          body: JSON.stringify({ status: newStatus })
        });
        const data = await res.json();
        if (!res.ok) return setMsg("apptMsg", data.error || "Update failed","error");
        setMsg("apptMsg","Status updated");
        if (selectedPatient) loadAppointments(selectedPatient.patient_id);
      } catch { setMsg("apptMsg","Server error","error"); }
    }

    window.cancelAppt = async function(appointmentId){
      if (!confirm("Cancel this appointment?")) return;
      try{
        const res = await fetch(`${API}/appointments/${appointmentId}`, {
          method:"DELETE", headers:{ "Authorization":"Bearer "+token }
        });
        const data = await res.json();
        if (!res.ok) return setMsg("apptMsg", data.error || "Cancel failed","error");
        setMsg("apptMsg","Appointment cancelled");
        if (selectedPatient) loadAppointments(selectedPatient.patient_id);
      } catch { setMsg("apptMsg","Server error","error"); }
    }

    // Search by name
    document.getElementById("search").addEventListener("input",(e)=>{
      const q = e.target.value.toLowerCase();
      filtered = patients.filter(p => (p.full_name || "").toLowerCase().includes(q));
      renderPatients();
    });

    document.getElementById("logoutBtn").addEventListener("click", ()=>{ localStorage.clear(); location.href="login.html"; });

    document.addEventListener("DOMContentLoaded", () => {
      const profileLink = document.getElementById("profileLink");
      if (profileLink) {
        profileLink.addEventListener("click", () => {
          window.location.href = "doctorProfile.html";
        });
      }
    });
    loadDoctorProfile();
    loadPatients();
  </script>
</body>
</html>
